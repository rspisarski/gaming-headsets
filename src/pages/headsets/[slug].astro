---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { getPriceCategory } from "../../content/config";
import Prose from "../../components/Prose.astro";
import HeadsetCard from "../../components/HeadsetCard.astro";
import settings from "../../data/settings.json";

export async function getStaticPaths() {
  const headsets = await getCollection("headsets");
  return headsets.map((headset) => ({
    params: { slug: headset.slug },
    props: { headset },
  }));
}

const { headset } = Astro.props;
const { Content } = await headset.render();

const priceCategory = getPriceCategory(headset.data.price);

// Get related headsets (same brand)
const allHeadsets = await getCollection("headsets");
const relatedHeadsets = allHeadsets
  .filter((h) => h.slug !== headset.slug && h.data.brand === headset.data.brand)
  .slice(0, 3);

const amazonLinks = headset.data.amazon_product_id
  ? [
      {
        url: `https://www.amazon.com/dp/${headset.data.amazon_product_id}?tag=${settings.amazon_tracking_id}`,
        label: "Buy on Amazon",
      },
    ]
  : [
      {
        url: headset.data.amazon_us
          ? `${headset.data.amazon_us}${headset.data.amazon_us.includes("?") ? "&" : "?"}tag=${settings.amazon_tracking_id}`
          : null,
        label: "Buy on Amazon",
      },
    ].filter((link) => link.url);

const specs = [
  { label: "Connection", value: headset.data.connection_types.join(", ") },
  {
    label: "Battery Life",
    value: headset.data.battery_life
      ? `${headset.data.battery_life} Hours`
      : "Wired",
  },
  { label: "Platforms", value: headset.data.platforms.join(", ") },
  {
    label: "Driver",
    value: `${headset.data.driver_size}mm ${headset.data.driver_type || ""}`,
  },
  { label: "Mic", value: headset.data.microphone_type },
  { label: "Surround", value: headset.data.surround_sound },
];
---

<Layout
  title={`${headset.data.brand} ${headset.data.name} - Detailed Specs & Comparison`}
  description={headset.data.description}
  image={headset.data.image}
>
  <main class="min-h-screen pt-24 pb-20 bg-background">
    <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Top Section -->
      <section
        class="grid grid-cols-1 lg:grid-cols-2 gap-16 mb-24 uppercase-none"
      >
        <!-- Product Image -->
        <div class="relative">
          <div
            class="aspect-[1/1] rounded-[2.5rem] overflow-hidden shadow-2xl bg-white p-3"
          >
            <img
              src={headset.data.image}
              alt={`${headset.data.brand} ${headset.data.name}`}
              class="w-full h-full object-contain"
              transition:name={`headset-${headset.slug}`}
            />
          </div>
        </div>

        <!-- Product Info -->
        <div class="flex flex-col justify-center">
          <div class="mb-8">
            <h2
              class="text-primary font-black tracking-[0.2em] uppercase text-sm mb-4"
            >
              {headset.data.brand}
            </h2>
            <h1
              class="text-3xl sm:text-4xl font-black text-text leading-tight tracking-tight"
            >
              {headset.data.name}
            </h1>
          </div>

          <p class="text-text/70 text-lg mb-10 leading-relaxed max-w-xl">
            {headset.data.description}
          </p>

          <div class="flex items-center gap-6 mb-12">
            <div class="bg-primary/10 px-5 py-2 rounded-xl">
              <span
                class="text-primary font-bold text-sm uppercase tracking-wider"
                >{priceCategory}</span
              >
            </div>
            <div class="h-1 w-1 bg-text/20 rounded-full"></div>
            <span class="text-text/50 font-medium"
              >{
                headset.data.connection_types.includes("2.4GHz Wireless")
                  ? "Wireless"
                  : "Wired"
              } Connection</span
            >
          </div>

          <div class="flex flex-wrap gap-4 mb-6">
            {
              amazonLinks.map((link) => (
                <a
                  href={link.url}
                  target="_blank"
                  rel="noopener noreferrer nofollow"
                  class="flex-1 min-w-[200px] inline-flex items-center justify-center gap-3 px-8 py-5 bg-primary text-white font-black text-lg rounded-2xl hover:bg-primary/80 transition-all shadow-xl shadow-primary/20 active:scale-95"
                >
                  {link.label}
                </a>
              ))
            }

            <button
              class="p-5 bg-card-bg text-text/40 hover:text-red-400 hover:bg-gray-800 rounded-2xl transition-all group/fav"
              data-headset-id={headset.slug}
              id="detail-favorite-button"
              aria-label="Add to favorites"
            >
              <svg
                class="w-8 h-8"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2.5"
                  d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                ></path>
              </svg>
            </button>
          </div>
          <p class="text-text/30 text-xs italic">
            * Affiliate Link: We may earn a commission from qualifying
            purchases.
          </p>
        </div>
      </section>

      <!-- Features Section -->
      <section class="mb-32">
        <h2 class="text-3xl font-bold text-text mb-12">
          Technical Specifications
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          <!-- Audio Specs -->
          <div
            class="bg-card-bg/30 p-10 rounded-[2.5rem] transition-all hover:bg-card-bg/50"
          >
            <div
              class="w-12 h-12 bg-primary/20 rounded-2xl flex items-center justify-center mb-8"
            >
              <svg
                class="w-6 h-6 text-primary"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"
                ></path></svg
              >
            </div>
            <h3 class="text-xl font-bold text-text mb-6">Audio Performance</h3>
            <div class="space-y-4">
              {
                Object.entries({
                  "Driver Type": headset.data.driver_type,
                  "Driver Size": headset.data.driver_size
                    ? `${headset.data.driver_size}mm`
                    : null,
                  "Frequency Range": headset.data.frequency_response,
                  Impedance: headset.data.impedance
                    ? `${headset.data.impedance}Î©`
                    : null,
                  Sensitivity: headset.data.sensitivity
                    ? `${headset.data.sensitivity}dB`
                    : null,
                  "Surround Sound": headset.data.surround_sound,
                  "Form Factor": headset.data.headphone_type,
                }).map(
                  ([label, value]) =>
                    value && (
                      <div class="flex justify-between items-start gap-4 group/item">
                        <span class="text-text/40 text-sm whitespace-nowrap">
                          {label}
                        </span>
                        <span class="text-text font-semibold text-sm text-right">
                          {value}
                        </span>
                      </div>
                    ),
                )
              }
            </div>
          </div>

          <!-- Mic & Connectivity -->
          <div
            class="bg-card-bg/30 p-10 rounded-[2.5rem] transition-all hover:bg-card-bg/50"
          >
            <div
              class="w-12 h-12 bg-blue-500/20 rounded-2xl flex items-center justify-center mb-8"
            >
              <svg
                class="w-6 h-6 text-blue-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
                ></path></svg
              >
            </div>
            <h3 class="text-xl font-bold text-text mb-6">Mic & Connectivity</h3>
            <div class="space-y-4">
              {
                Object.entries({
                  Microphone: headset.data.microphone_type,
                  "Detachable Mic": headset.data.mic_detachable ? "Yes" : "No",
                  "Mic Monitoring": headset.data.mic_monitoring ? "Yes" : "No",
                  Connection: headset.data.connection_types.join(", "),
                  "Battery Life": headset.data.battery_life
                    ? `${headset.data.battery_life} Hours`
                    : "Wired Only",
                  Charging: headset.data.charging_type,
                  "Wireless Range": headset.data.wireless_range
                    ? `${headset.data.wireless_range}ft`
                    : null,
                }).map(
                  ([label, value]) =>
                    value && (
                      <div class="flex justify-between items-start gap-4">
                        <span class="text-text/40 text-sm whitespace-nowrap">
                          {label}
                        </span>
                        <span class="text-text font-semibold text-sm text-right">
                          {value}
                        </span>
                      </div>
                    ),
                )
              }
            </div>
          </div>

          <!-- Build & Tech -->
          <div
            class="bg-card-bg/30 p-10 rounded-[2.5rem] transition-all hover:bg-card-bg/50"
          >
            <div
              class="w-12 h-12 bg-purple-500/20 rounded-2xl flex items-center justify-center mb-8"
            >
              <svg
                class="w-6 h-6 text-purple-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
                ></path></svg
              >
            </div>
            <h3 class="text-xl font-bold text-text mb-6">Build & Tech</h3>
            <div class="space-y-4">
              {
                Object.entries({
                  Weight: headset.data.weight
                    ? `${headset.data.weight}g`
                    : null,
                  Material: headset.data.build_material,
                  Cushions: headset.data.cushion_materials?.join(", "),
                  "Ear Design": headset.data.ear_cup_design,
                  Software:
                    headset.data.software_name ||
                    (headset.data.has_software ? "Yes" : "No"),
                  RGB: headset.data.rgb_lighting,
                  Warranty: `${headset.data.warranty_years} Year(s)`,
                  "Active Tech": headset.data.active_features.join(", "),
                  "In the Box": headset.data.included_accessories.join(", "),
                }).map(
                  ([label, value]) =>
                    value && (
                      <div class="flex justify-between items-start gap-4">
                        <span class="text-text/40 text-sm whitespace-nowrap">
                          {label}
                        </span>
                        <span class="text-text font-semibold text-sm text-right">
                          {value}
                        </span>
                      </div>
                    ),
                )
              }
            </div>
          </div>
        </div>
      </section>

      <!-- Content Section -->
      <section class="mb-32">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-16">
          <div class="lg:col-span-12">
            <h2 class="text-3xl font-bold text-text mb-12">The Details</h2>
            <Prose>
              <Content />
            </Prose>
          </div>
        </div>
      </section>

      <!-- Related Headsets -->
      {
        relatedHeadsets.length > 0 && (
          <section>
            <div class="flex items-center justify-between mb-12">
              <div>
                <h2 class="text-3xl font-bold text-text">
                  More from {headset.data.brand}
                </h2>
                <p class="text-text/40 mt-2 text-sm">
                  Discover other headsets in their lineup
                </p>
              </div>
              <a
                href={`/?brand=${headset.data.brand}`}
                class="group flex items-center gap-3 text-primary font-bold transition-all"
              >
                <span>View All</span>
                <svg
                  class="w-5 h-5 group-hover:translate-x-1 transition-transform"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17 8l4 4m0 0l-4 4m4-4H3"
                  />
                </svg>
              </a>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">
              {relatedHeadsets.map((h) => (
                <HeadsetCard headset={{ ...h.data, slug: h.slug }} />
              ))}
            </div>
          </section>
        )
      }
    </div>
  </main>

  <script>
    function initFavorite() {
      const btn = document.getElementById("detail-favorite-button");
      if (!btn) return;

      const slug = btn.dataset.headsetId;
      const getFavorites = () =>
        JSON.parse(localStorage.getItem("headsetFavorites") || "[]");

      const updateUI = () => {
        const favs = getFavorites();
        const isFav = favs.includes(slug);
        const icon = btn.querySelector("svg");
        if (isFav) {
          btn.classList.add("text-red-400", "bg-red-400/10");
          btn.classList.remove("text-text/40", "bg-card-bg");
          icon?.setAttribute("fill", "currentColor");
        } else {
          btn.classList.remove("text-red-400", "bg-red-400/10");
          btn.classList.add("text-text/40", "bg-card-bg");
          icon?.setAttribute("fill", "none");
        }
      };

      btn.addEventListener("click", () => {
        let favs = getFavorites();
        if (favs.includes(slug)) {
          favs = favs.filter((s: string) => s !== slug);
        } else {
          favs.push(slug);
        }
        localStorage.setItem("headsetFavorites", JSON.stringify(favs));
        updateUI();
      });

      updateUI();
    }

    document.addEventListener("astro:page-load", initFavorite);
  </script>
</Layout>

<style>
  /* Premium Type Improvements */
  h1,
  h2,
  h3 {
    letter-spacing: -0.02em;
  }
</style>
