---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import HeadsetCard from "../components/HeadsetCard.astro";

const allHeadsets = await getCollection("headsets");
---

<Layout
    title="Your Favorite Headsets - Goop Finder"
    description="View and compare the gaming headsets you've saved to your favorites list."
>
    <main class="min-h-screen pt-24 pb-20 bg-background">
        <div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="mb-12">
                <h1 class="text-4xl sm:text-5xl font-black text-text mb-4">
                    Your Favorites
                </h1>
                <p class="text-text/60 text-lg">
                    Compare and view your saved gaming headsets.
                </p>
            </div>

            <div
                id="favorites-grid"
                class="hidden grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
            >
                {
                    allHeadsets.map((headset) => (
                        <div
                            class="favorite-item-wrapper h-full hidden"
                            data-slug={headset.slug}
                        >
                            <HeadsetCard
                                headset={{
                                    ...headset.data,
                                    slug: headset.slug,
                                }}
                            />
                        </div>
                    ))
                }
            </div>

            <div
                id="no-favorites"
                class="hidden flex flex-col items-center justify-center py-20 text-center"
            >
                <div
                    class="w-20 h-20 bg-card-bg rounded-3xl flex items-center justify-center mb-6"
                >
                    <svg
                        class="w-10 h-10 text-text/20"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
                        ></path>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-text mb-2">
                    No favorites yet
                </h2>
                <p class="text-text/50 max-w-sm mb-10">
                    Start browsing headsets and tap the heart icon to save your
                    top picks here.
                </p>
                <a
                    href="/"
                    class="px-8 py-4 bg-primary text-white font-bold rounded-2xl hover:bg-primary/80 transition-all shadow-xl shadow-primary/20"
                >
                    Browse Headsets
                </a>
            </div>
        </div>
    </main>

    <script>
        function renderFavorites() {
            const grid = document.getElementById("favorites-grid");
            const emptyState = document.getElementById("no-favorites");
            const favorites = JSON.parse(
                localStorage.getItem("headsetFavorites") || "[]",
            );

            const items = document.querySelectorAll(".favorite-item-wrapper");
            let foundCount = 0;

            items.forEach((item) => {
                const slug = (item as HTMLElement).dataset.slug;
                if (favorites.includes(slug)) {
                    item.classList.remove("hidden");
                    foundCount++;
                } else {
                    item.classList.add("hidden");
                }
            });

            if (foundCount === 0) {
                grid?.classList.add("hidden");
                grid?.classList.remove("grid");
                emptyState?.classList.remove("hidden");
            } else {
                grid?.classList.remove("hidden");
                grid?.classList.add("grid");
                emptyState?.classList.add("hidden");
            }
        }

        // Handle favorite buttons inside the cards (standard favorite-button class)
        function setupFavoriteButtons() {
            document.querySelectorAll(".favorite-button").forEach((btn) => {
                btn.addEventListener("click", () => {
                    // Give the storage a tiny bit of time to update from the global handler
                    // or just re-run the favorites filter.
                    setTimeout(renderFavorites, 50);
                });
            });
        }

        document.addEventListener("astro:page-load", () => {
            renderFavorites();
            setupFavoriteButtons();
        });
    </script>
</Layout>
