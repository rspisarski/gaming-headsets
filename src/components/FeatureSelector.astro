---
import { VALID_FEATURES } from '../lib/features.js';

interface Props {
  brands: string[];
  initialCount: number;
}

const { brands, initialCount } = Astro.props as Props;

// Price tiers
const PRICE_TIERS = {
  affordable: '$0-75',
  budget: '$76-150',
  premium: '$151-250',
  'ultra-premium': '$251+'
};
---

<div>
  <h2 class="text-2xl font-semibold mb-6 text-dark-text-primary">Find Your Perfect Headset</h2>
   <p class="text-dark-text-secondary mb-6">Click on features below to select them as "Must Have" or "Nice to Have". Must have features are required for matches, nice to have features improve your score.</p>

   <!-- Available Features -->
   <div class="rounded-xl p-6 shadow-sm bg-dark-surface/50">
     <h3 class="text-lg font-semibold mb-4 text-dark-text-primary border-b border-dark-border pb-2 flex items-center">
        Available Features
        <span class="text-sm font-normal text-dark-text-secondary ml-2 bg-dark-surface px-2 py-1 rounded-full border border-dark-border">(Click to select)</span>
      </h3>

       <div class="grid grid-cols-4 gap-3" id="available-features">
         <!-- Platform Compatibility -->
         <div class="p-2">
            <h4 class="font-medium mb-1 text-xs uppercase text-dark-text-secondary tracking-wide">Platform Compatibility</h4>
            <div class="flex flex-wrap gap-1">
             {VALID_FEATURES.COMPATIBILITY.map(platform => (
                <div
                  class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                  data-feature="compatibility"
                  data-value={platform}
                >
                 {platform}
               </div>
             ))}
          </div>
        </div>

         <!-- Connectivity -->
         <div class="p-2">
            <h4 class="font-medium mb-1 text-xs uppercase text-dark-text-secondary tracking-wide">Connectivity</h4>
            <div class="flex flex-wrap gap-1">
             {VALID_FEATURES.CORD_TYPE.map(cordType => (
               <div
                 class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                 data-feature="cord_type"
                 data-value={cordType}

               >
                 {cordType.replace('_', ' ')}
               </div>
             ))}
          </div>
        </div>

         <!-- Audio Features -->
         <div class="p-2">
            <h4 class="font-medium mb-1 text-xs uppercase text-dark-text-secondary tracking-wide">Audio Features</h4>
            <div class="flex flex-wrap gap-1">
             {VALID_FEATURES.MICROPHONE_TYPE.map(micType => (
               <div
                 class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                 data-feature="microphone_type"
                 data-value={micType}

               >
                 {micType.replace('_', ' ')}
               </div>
             ))}

             {VALID_FEATURES.NOISE_CANCELLATION.map(noiseType => (
               <div
                 class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                 data-feature="noise_cancellation"
                 data-value={noiseType}

               >
                 {noiseType.replace('_', ' ')}
               </div>
             ))}
          </div>
        </div>

         <!-- Customization -->
         <div class="p-2">
            <h4 class="font-medium mb-1 text-xs uppercase text-dark-text-secondary tracking-wide">Customization</h4>
            <div class="flex flex-wrap gap-1">
             {VALID_FEATURES.RGB_LIGHTING.map(rgbType => (
               <div
                 class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                 data-feature="rgb_lighting"
                 data-value={rgbType}

               >
                 RGB {rgbType}
               </div>
             ))}

             <div
               class="feature-item px-2 py-1 bg-gray-100 border border-gray-300 rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
               data-feature="replaceable_earpads"
               data-value="true"
             >
               Replaceable Earpads
             </div>
          </div>
        </div>

         <!-- Software -->
         <div class="p-2">
            <h4 class="font-medium mb-1 text-xs uppercase text-dark-text-secondary tracking-wide">Software</h4>
            <div class="flex flex-wrap gap-1">
             {VALID_FEATURES.SOFTWARE_SUPPORT.map(softwareLevel => (
               <div
                 class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                 data-feature="software_support"
                 data-value={softwareLevel}

               >
                 {softwareLevel} software
               </div>
             ))}

             {VALID_FEATURES.SOFTWARE_APPS.map(app => (
               <div
                 class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                 data-feature="software_app"
                 data-value={app}

               >
                 {app}
               </div>
             ))}
          </div>
        </div>

         <!-- Brands -->
         <div class="p-2">
            <h4 class="font-medium mb-1 text-xs uppercase text-dark-text-secondary tracking-wide">Brands</h4>
            <div class="flex flex-wrap gap-1">
             {brands.map(brand => (
               <div
                 class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                 data-feature="brand"
                 data-value={brand}

               >
                 {brand}
               </div>
             ))}
          </div>
        </div>

         <!-- Price Tiers -->
         <div class="p-2">
            <h4 class="font-medium mb-1 text-xs uppercase text-dark-text-secondary tracking-wide">Price Tiers</h4>
            <div class="flex flex-wrap gap-1">
             {Object.entries(PRICE_TIERS).map(([tier, range]) => (
               <div
                 class="feature-item px-2 py-1 border rounded-full cursor-pointer transition-all duration-200 text-xs text-center font-medium"
                 data-state="none"
                 data-feature="price_tier"
                 data-value={tier}

               >
                 {tier.replace('-', ' ')} ({range})
               </div>
             ))}
          </div>
         </div>
       </div>
     </div>

     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Must Have Features -->
        <div class="must-have-zone rounded-xl p-6 min-h-96">
          <h3 class="text-lg font-semibold mb-4 text-soft-periwinkle-300 border-b-2 border-soft-periwinkle-600/50 pb-2 flex items-center">
            <span class="text-2xl mr-2">‚ù§Ô∏è</span>
            Must Have Features
            <span class="text-sm font-normal text-soft-periwinkle-400 ml-2 bg-dark-surface px-2 py-1 rounded-full border border-dark-border">(<span id="must-have-count">0</span> selected)</span>
          </h3>

          <div id="must-have-features" class="flex flex-wrap gap-2">
            <!-- Features will be added here via JavaScript -->
            <div class="text-dark-text-muted text-sm italic text-center py-8 w-full">
              Click features above to add as must-have requirements
            </div>
          </div>
        </div>

        <!-- Nice to Have Features -->
        <div class="nice-to-have-zone rounded-xl p-6 min-h-96">
          <h3 class="text-lg font-semibold mb-4 text-frozen-lake-300 border-b-2 border-frozen-lake-600/50 pb-2 flex items-center">
            <span class="text-2xl mr-2">üëç</span>
            Nice to Have Features
            <span class="text-sm font-normal text-frozen-lake-400 ml-2 bg-dark-surface px-2 py-1 rounded-full border border-dark-border">(<span id="nice-to-have-count">0</span> selected)</span>
          </h3>

          <div id="nice-to-have-features" class="flex flex-wrap gap-2">
            <!-- Features will be added here via JavaScript -->
            <div class="text-dark-text-muted text-sm italic text-center py-8 w-full">
              Click features above to add as nice-to-have preferences
            </div>
          </div>
        </div>
     </div>

   <!-- Action Buttons -->
   <!-- Action Buttons and Result Info -->
   <div class="mt-8 mb-8 flex flex-col md:flex-row gap-4 justify-between items-center bg-dark-card p-4 rounded-xl border border-dark-border shadow-sm">
     <div class="flex gap-3 w-full md:w-auto">
       <button
         id="find-matches"
         class="flex-1 md:flex-none px-8 py-3 bg-gradient-to-r from-soft-periwinkle-600 to-mauve-600 text-white rounded-lg hover:from-soft-periwinkle-700 hover:to-mauve-700 transition-all duration-200 font-bold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
       >
         <span class="mr-2">üîç</span>
         Find Matches
       </button>
       <button
         id="clear-features"
         class="flex-1 md:flex-none px-6 py-3 bg-dark-surface text-dark-text-primary rounded-lg border border-dark-border hover:bg-dark-bg transition-all duration-200 shadow-sm hover:shadow-md"
       >
         <span class="mr-2">üóëÔ∏è</span>
         Clear All
       </button>
     </div>

     <p class="text-dark-text-secondary mt-4 md:mt-0 font-medium">
       Showing <span id="results-count" class="text-dark-text-primary font-bold text-lg">{initialCount}</span> headsets
     </p>
   </div>
</div>

 <style is:global>

    .feature-item {
      background-color: var(--soft-periwinkle-800);
      border-color: var(--soft-periwinkle-600);
      color: var(--dark-text-primary);
      transition: filter 0.2s ease;
    }
    .feature-item:hover {
      filter: brightness(1.1);
    }
    .feature-item.state-must {
      background: linear-gradient(135deg, var(--soft-periwinkle-600) 0%, var(--mauve-600) 100%);
      color: white;
      border-color: var(--soft-periwinkle-700);
    }
    .feature-item.state-nice {
      background: linear-gradient(135deg, var(--frozen-lake-600) 0%, var(--frozen-lake-500) 100%);
      color: white;
      border-color: var(--frozen-lake-700);
    }

    .must-have-zone {
      background: transparent;
    }
    .nice-to-have-zone {
      background: transparent;
    }
 </style>

  <script>
    // Feature selector click functionality will be handled by main filtering script
    
    // Style features when they're moved to must-have/nice-to-have zones
    document.addEventListener('DOMContentLoaded', function() {
      function styleMovedFeatures() {
        // Style features in must-have zone - add state-must class to trigger existing CSS
        const mustHaveItems = document.querySelectorAll('#must-have-features .feature-item');
        mustHaveItems.forEach(item => {
          if (item instanceof HTMLElement) {
            // Remove any existing state classes first
            item.classList.remove('state-must', 'state-nice');
            // Add state-must class to trigger existing CSS gradient styling
            item.classList.add('state-must');
          }
        });
        
        // Style features in nice-to-have zone - add state-nice class to trigger existing CSS
        const niceToHaveItems = document.querySelectorAll('#nice-to-have-features .feature-item');
        niceToHaveItems.forEach(item => {
          if (item instanceof HTMLElement) {
            // Remove any existing state classes first
            item.classList.remove('state-must', 'state-nice');
            // Add state-nice class to trigger existing CSS gradient styling
            item.classList.add('state-nice');
          }
        });
        
        // Hide placeholder text when features are present
        const mustHaveContainer = document.getElementById('must-have-features');
        const niceToHaveContainer = document.getElementById('nice-to-have-features');
        
        if (mustHaveContainer && mustHaveContainer.querySelectorAll('.feature-item').length > 0) {
          const placeholder = mustHaveContainer.querySelector('.text-dark-text-muted');
          if (placeholder instanceof HTMLElement) {
            placeholder.style.display = 'none';
          }
        }
        
        if (niceToHaveContainer && niceToHaveContainer.querySelectorAll('.feature-item').length > 0) {
          const placeholder = niceToHaveContainer.querySelector('.text-dark-text-muted');
          if (placeholder instanceof HTMLElement) {
            placeholder.style.display = 'none';
          }
        }
      }
      
      // Initial styling and watch for changes
      styleMovedFeatures();
      
      // Observer for DOM changes (when features are added/removed)
      const observer = new MutationObserver(styleMovedFeatures);
      const mustHaveElement = document.getElementById('must-have-features');
      const niceToHaveElement = document.getElementById('nice-to-have-features');
      
      if (mustHaveElement) {
        observer.observe(mustHaveElement, { childList: true });
      }
      if (niceToHaveElement) {
        observer.observe(niceToHaveElement, { childList: true });
      }
    });
  </script>