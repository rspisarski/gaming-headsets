---
interface HeadsetData {
  slug: string;
  name: string;
  brand: string;
  price: number;
  image: string;
  connection_types: string[];
  platforms: string[];
  microphone_type: string;
  surround_sound: string;
  active_features: string[];
  rgb_lighting: string;
}

interface Props {
  headsets: HeadsetData[];
}

const { headsets } = Astro.props;

import PriceFilter from "./filters/PriceFilter.astro";
import BrandFilter from "./filters/BrandFilter.astro";
import ConnectivityFilter from "./filters/ConnectivityFilter.astro";
import PlatformFilter from "./filters/PlatformFilter.astro";
import AdvancedFilters from "./filters/AdvancedFilters.astro";

const uniqueBrands = [...new Set(headsets.map((h) => h.brand))]
  .map((brand) => ({
    name: brand,
    count: headsets.filter((h) => h.brand === brand).length,
  }))
  .sort((a, b) => {
    if (b.count !== a.count) {
      return b.count - a.count; // Sort by count (descending)
    }
    return a.name.localeCompare(b.name); // Then alphabetically
  })
  .map((item) => item.name);
---

<div class="flex flex-col lg:flex-row gap-8">
  <aside
    id="filters-sidebar"
    class="fixed inset-0 z-50 bg-black/95 backdrop-blur-sm transition-transform duration-300 translate-x-full lg:translate-x-0 lg:static lg:bg-transparent lg:w-72 lg:block lg:flex-shrink-0"
  >
    <div
      class="h-full overflow-y-auto lg:h-auto lg:overflow-visible bg-card-bg lg:bg-card-bg p-6 lg:sticky lg:top-24"
    >
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-text">Filters</h2>
        <div class="flex items-center gap-4">
          <button
            id="clear-all-filters"
            class="text-sm text-primary hover:text-primary/80 transition-colors"
          >
            Clear All
          </button>
          <button
            id="close-filters-btn"
            class="lg:hidden text-text/60 hover:text-text transition-colors"
            aria-label="Close filters"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      </div>

      <PriceFilter />
      <BrandFilter brands={uniqueBrands} />
      <ConnectivityFilter />
      <PlatformFilter />
      <AdvancedFilters />

      <!-- Mobile Apply Button (Optional, but good UX) -->
      <div class="mt-8 pt-6 border-t border-gray-800 lg:hidden">
        <button
          id="mobile-apply-filters"
          class="w-full bg-primary text-white font-bold py-3 rounded-lg hover:bg-primary/90 transition-colors"
        >
          View Results
        </button>
      </div>
    </div>
  </aside>

  <div class="flex-1">
    <div
      class="sticky top-16 z-30 bg-background/95 backdrop-blur-md -mx-4 px-4 py-3 mb-6 border-b border-white/10 lg:static lg:bg-transparent lg:border-none lg:p-0 lg:m-0 lg:mb-6 transition-all"
    >
      <div class="flex items-center justify-between gap-4">
        <div>
          <h2 class="text-lg font-bold text-text lg:text-xl">All Headsets</h2>
          <p class="text-text/60 text-xs lg:text-sm">
            <span id="results-count">0</span> headsets found
          </p>
        </div>

        <div class="flex items-center gap-3">
          <button
            id="sticky-filter-toggle"
            class="lg:hidden flex items-center gap-2 px-3 py-2 bg-card-bg border border-gray-700 rounded-lg text-sm font-medium text-text hover:bg-gray-800 transition-colors"
          >
            <svg
              class="w-4 h-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
              ></path>
            </svg>
            <span class="hidden sm:inline">Filters</span>
          </button>

          <!-- View Toggle Buttons -->
          <div class="flex items-center gap-1 bg-gray-800 rounded-lg p-1">
            <button
              id="grid-view-btn"
              class="view-toggle-btn px-3 py-2 rounded-md text-sm font-medium transition-colors bg-primary text-white"
              data-view="grid"
              aria-label="Grid view"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                ></path>
              </svg>
            </button>
            <button
              id="list-view-btn"
              class="view-toggle-btn px-3 py-2 rounded-md text-sm font-medium transition-colors text-text/60 hover:text-text"
              data-view="list"
              aria-label="List view"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="headsets-grid"
      class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 relative"
    >
    </div>

    <div id="headsets-list" class="hidden space-y-1"></div>

    <div
      id="no-results"
      class="hidden text-center py-12 bg-black border border-primary/20"
    >
      <p class="text-text/60">No headsets found matching your criteria.</p>
    </div>

    <div id="pagination" class="mt-8 flex justify-center items-center gap-2">
    </div>
  </div>

  <style is:global>
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeInUp 0.3s ease-out;
    }

    .fade-in > div:nth-child(1),
    .fade-in > div:nth-child(2),
    .fade-in > div:nth-child(3) {
      animation-delay: 0.05s;
    }

    .fade-in > div:nth-child(4),
    .fade-in > div:nth-child(5),
    .fade-in > div:nth-child(6) {
      animation-delay: 0.1s;
    }

    .fade-in > div:nth-child(7),
    .fade-in > div:nth-child(8),
    .fade-in > div:nth-child(9) {
      animation-delay: 0.15s;
    }

    .fade-in > div:nth-child(10),
    .fade-in > div:nth-child(11),
    .fade-in > div:nth-child(12) {
      animation-delay: 0.2s;
    }
  </style>

  <script define:vars={{ headsets }}>
    let allHeadsets = headsets;
    let filteredHeadsets = [...allHeadsets];
    let currentPage = 1;
    const itemsPerPage = 12;
    let currentView = localStorage.getItem("headset-view") || "grid";

    const selectedFilters = {
      priceCategories: new Set(),
      brands: new Set(),
      platforms: new Set(),
      platformLogic: "OR", // 'OR' or 'AND'
      microphoneTypes: new Set(),
      surroundSounds: new Set(),
      noiseCancellation: null,
      rgbLighting: new Set(),
      wireless: false,
      wired: false,
    };

    function getPriceCategory(price) {
      if (price < 75) return "Budget";
      if (price < 150) return "Value";
      if (price < 250) return "Mid-range";
      if (price < 400) return "Premium";
      return "Flagship";
    }

    function isWireless(connectionTypes) {
      if (!connectionTypes || !Array.isArray(connectionTypes)) return false;
      return connectionTypes.some(
        (type) => type === "2.4GHz Wireless" || type === "Bluetooth",
      );
    }

    function isWired(connectionTypes) {
      if (!connectionTypes || !Array.isArray(connectionTypes)) return false;
      return connectionTypes.some(
        (type) => type === "3.5mm" || type === "USB-A" || type === "USB-C",
      );
    }

    function applyFilters() {
      filteredHeadsets = allHeadsets.filter((headset) => {
        if (selectedFilters.priceCategories.size > 0) {
          const category = getPriceCategory(headset.price);
          if (!selectedFilters.priceCategories.has(category)) return false;
        }

        if (
          selectedFilters.brands.size > 0 &&
          !selectedFilters.brands.has(headset.brand)
        )
          return false;

        if (selectedFilters.wireless && !isWireless(headset.connection_types))
          return false;
        if (selectedFilters.wired && !isWired(headset.connection_types))
          return false;

        if (selectedFilters.platforms.size > 0) {
          const platforms = headset.platforms || [];
          if (selectedFilters.platformLogic === "AND") {
            // Match ALL selected platforms
            const hasAll = [...selectedFilters.platforms].every((platform) =>
              platforms.includes(platform),
            );
            if (!hasAll) return false;
          } else {
            // Match ANY selected platform (default)
            const hasMatch = selectedFilters.platforms.some((platform) =>
              platforms.includes(platform),
            );
            if (!hasMatch) return false;
          }
        }

        if (
          selectedFilters.microphoneTypes.size > 0 &&
          !selectedFilters.microphoneTypes.has(headset.microphone_type)
        )
          return false;

        if (
          selectedFilters.surroundSounds.size > 0 &&
          !selectedFilters.surroundSounds.has(headset.surround_sound)
        )
          return false;

        if (selectedFilters.noiseCancellation) {
          const hasANC =
            headset.active_features &&
            headset.active_features.includes("Active Noise Cancellation");
          if (selectedFilters.noiseCancellation === "Active" && !hasANC)
            return false;
          if (selectedFilters.noiseCancellation === "None" && hasANC)
            return false;
        }

        if (
          selectedFilters.rgbLighting.size > 0 &&
          !selectedFilters.rgbLighting.has(headset.rgb_lighting)
        )
          return false;

        return true;
      });

      currentPage = 1;
      updateURL();
      displayResults();
    }

    function createHeadsetCard(headset, view = "grid") {
      const element = document.createElement("div");

      if (view === "list") {
        // List view: compact text-based layout
        const connectivity = isWireless(headset.connection_types)
          ? "Wireless"
          : "Wired";

        element.innerHTML = `
          <a href="/headsets/${headset.slug}" class="block px-4 py-2 group relative hover:shadow-[0_0_40px_rgba(139,213,27,0.3)] transition-all duration-300">
            <div class="flex items-center justify-between">
              <div class="min-w-0 flex-1">
                <span class="text-xs font-bold tracking-wider text-primary uppercase">${headset.brand}</span>
                <h3 class="text-lg font-semibold text-text leading-tight group-hover:text-primary transition-colors">${headset.name}</h3>
              </div>
              
              <div class="flex items-center gap-4 ml-4 text-sm text-text/60">
                <span>${connectivity}</span>
              </div>
            </div>
          </a>
        `;
      } else {
        // Grid view: existing card layout
        element.className =
          "group bg-card-bg relative z-0 hover:z-10 rounded-xl shadow-sm hover:shadow-[0_0_80px_rgba(139,213,27,0.4)] transition-all duration-300 overflow-hidden flex flex-col h-full";

        element.innerHTML = `
          <div class="relative w-full aspect-[4/3] bg-white overflow-hidden group-hover:scale-[1.02] transition-transform duration-500 ${headset.image_thumbnail_contain ? "p-4" : "p-0"}">
            <img 
              src="${headset.image}" 
              alt="${headset.brand} ${headset.name} gaming headset"
              class="w-full h-full ${headset.image_thumbnail_contain ? "object-contain" : "object-cover"}"
              loading="lazy"
            />
            
          </div>
          
          <div class="p-5 flex flex-col flex-1">
            <div class="mb-4">
              <div class="flex justify-between items-start mb-1">
                <span class="text-xs font-bold tracking-wider text-primary uppercase">${headset.brand}</span>
              </div>
              <h3 class="text-xl font-bold text-text leading-tight group-hover:text-primary transition-colors">${headset.name}</h3>
            </div>

            <div class="flex-1"></div>
            
            <div class="mt-auto pt-4 border-t border-gray-700/50 flex items-center gap-3">
              <a
                href="/headsets/${headset.slug}"
                class="flex-1 text-center px-4 py-2 bg-primary hover:bg-primary/80 text-white text-sm font-semibold rounded-lg transition-colors"
              >
                View Details
              </a>
              <button
                class="favorite-toggle p-2 text-text/40 hover:text-red-400 hover:bg-white/5 rounded-lg transition-all"
                data-slug="${headset.slug}"
                aria-label="Toggle Favorite"
              >
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
              </button>
            </div>
          </div>
        `;
      }

      return element;
    }

    function displayResults() {
      const grid = document.getElementById("headsets-grid");
      const list = document.getElementById("headsets-list");
      const resultsCount = document.getElementById("results-count");
      const noResults = document.getElementById("no-results");
      const pagination = document.getElementById("pagination");

      if (!grid || !list) return;

      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedHeadsets = filteredHeadsets.slice(startIndex, endIndex);

      // Clear both containers
      grid.innerHTML = "";
      list.innerHTML = "";

      // Remove animation classes
      grid.classList.remove("fade-in");
      list.classList.remove("fade-in");

      // Show/hide appropriate container
      if (currentView === "list") {
        grid.classList.add("hidden");
        list.classList.remove("hidden");

        paginatedHeadsets.forEach((headset) => {
          const item = createHeadsetCard(headset, "list");
          list.appendChild(item);
        });

        requestAnimationFrame(() => {
          list.classList.add("fade-in");
        });
      } else {
        grid.classList.remove("hidden");
        list.classList.add("hidden");

        paginatedHeadsets.forEach((headset) => {
          const card = createHeadsetCard(headset, "grid");
          grid.appendChild(card);
        });

        requestAnimationFrame(() => {
          grid.classList.add("fade-in");
        });
      }

      if (resultsCount) {
        resultsCount.textContent = filteredHeadsets.length;
      }

      if (noResults) {
        if (filteredHeadsets.length === 0) {
          noResults.classList.remove("hidden");
        } else {
          noResults.classList.add("hidden");
        }
      }

      updatePagination();
      updateFavoriteButtons();
    }

    function updateFavoriteButtons() {
      const favorites = JSON.parse(
        localStorage.getItem("headsetFavorites") || "[]",
      );
      document.querySelectorAll(".favorite-toggle").forEach((btn) => {
        const slug = btn.dataset.slug;
        const icon = btn.querySelector("svg");
        if (favorites.includes(slug)) {
          btn.classList.add("text-red-400", "bg-red-400/10");
          btn.classList.remove("text-text/40");
          icon.setAttribute("fill", "currentColor");
        } else {
          btn.classList.remove("text-red-400", "bg-red-400/10");
          btn.classList.add("text-text/40");
          icon.setAttribute("fill", "none");
        }
      });
    }

    // Handle favorite toggles using event delegation
    document.addEventListener("click", (e) => {
      const btn = e.target.closest(".favorite-toggle");
      if (btn) {
        const slug = btn.dataset.slug;
        let favorites = JSON.parse(
          localStorage.getItem("headsetFavorites") || "[]",
        );
        if (favorites.includes(slug)) {
          favorites = favorites.filter((s) => s !== slug);
        } else {
          favorites.push(slug);
        }
        localStorage.setItem("headsetFavorites", JSON.stringify(favorites));
        updateFavoriteButtons();
      }
    });

    function toggleBrandShowMore() {
      const button = document.getElementById("brand-show-more");
      const hiddenItems = document.querySelectorAll(".brand-item.hidden");

      if (hiddenItems.length > 0) {
        // Show more
        hiddenItems.forEach((item) => item.classList.remove("hidden"));
        button.textContent = "Show Less";
      } else {
        // Show less
        const allItems = document.querySelectorAll(".brand-item");
        allItems.forEach((item, index) => {
          if (index >= 5) {
            item.classList.add("hidden");
          }
        });
        button.textContent = "Show More";
      }
    }

    function togglePlatformShowMore() {
      const button = document.getElementById("platform-show-more");
      const hiddenItems = document.querySelectorAll(".platform-item.hidden");

      if (hiddenItems.length > 0) {
        // Show more
        hiddenItems.forEach((item) => item.classList.remove("hidden"));
        button.textContent = "Show Less";
      } else {
        // Show less
        const allItems = document.querySelectorAll(".platform-item");
        allItems.forEach((item, index) => {
          if (index >= 5) {
            item.classList.add("hidden");
          }
        });
        button.textContent = "Show More";
      }
    }

    function updatePagination() {
      const paginationContainer = document.getElementById("pagination");
      if (!paginationContainer) return;

      const totalPages = Math.ceil(filteredHeadsets.length / itemsPerPage);

      if (totalPages <= 1) {
        paginationContainer.innerHTML = "";
        return;
      }

      let paginationHTML = "";

      paginationHTML += `
        <button 
          onclick="goToPage(${currentPage - 1})"
          ${currentPage === 1 ? "disabled" : ""}
          class="px-3 py-2 bg-card-bg border border-gray-700 rounded-lg text-text hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Previous
        </button>
      `;

      for (let i = 1; i <= totalPages; i++) {
        if (
          i === 1 ||
          i === totalPages ||
          (i >= currentPage - 1 && i <= currentPage + 1)
        ) {
          paginationHTML += `
            <button 
              onclick="goToPage(${i})"
              class="px-3 py-2 ${i === currentPage ? "bg-primary text-white" : "bg-card-bg text-text hover:bg-gray-800"} border border-gray-700 rounded-lg transition-colors"
            >
              ${i}
            </button>
          `;
        } else if (i === currentPage - 2 || i === currentPage + 2) {
          paginationHTML += `<span class="px-2 text-text/60">...</span>`;
        }
      }

      paginationHTML += `
        <button 
          onclick="goToPage(${currentPage + 1})"
          ${currentPage === totalPages ? "disabled" : ""}
          class="px-3 py-2 bg-card-bg border border-gray-700 rounded-lg text-text hover:bg-gray-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Next
        </button>
      `;

      paginationContainer.innerHTML = paginationHTML;
    }

    function goToPage(page) {
      currentPage = page;
      displayResults();
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function clearAllFilters() {
      selectedFilters.priceCategories.clear();
      selectedFilters.brands.clear();

      selectedFilters.platforms.clear();
      selectedFilters.platformLogic = "OR";
      document.getElementById("platform-logic-toggle").checked = false;
      selectedFilters.microphoneTypes.clear();
      selectedFilters.surroundSounds.clear();
      selectedFilters.noiseCancellation = null;
      selectedFilters.rgbLighting.clear();
      selectedFilters.wireless = false;
      selectedFilters.wired = false;

      document
        .querySelectorAll(
          ".price-filter, .brand-filter, .platform-filter, .mic-filter, .surround-filter, .rgb-filter",
        )
        .forEach((cb) => {
          cb.checked = false;
        });
      document.getElementById("filter-wireless").checked = false;
      document.getElementById("filter-wired").checked = false;
      document
        .querySelectorAll(".nc-filter")
        .forEach((rb) => (rb.checked = false));

      applyFilters();
    }

    function updateURL() {
      const params = new URLSearchParams();

      if (selectedFilters.priceCategories.size > 0) {
        params.set("price", [...selectedFilters.priceCategories].join(","));
      }
      if (selectedFilters.brands.size > 0) {
        params.set("brand", [...selectedFilters.brands].join(","));
      }
      if (selectedFilters.platforms.size > 0) {
        params.set("platform", [...selectedFilters.platforms].join(","));
      }
      if (selectedFilters.microphoneTypes.size > 0) {
        params.set("mic", [...selectedFilters.microphoneTypes].join(","));
      }
      if (selectedFilters.surroundSounds.size > 0) {
        params.set("surround", [...selectedFilters.surroundSounds].join(","));
      }
      if (selectedFilters.noiseCancellation) {
        params.set("nc", selectedFilters.noiseCancellation);
      }
      if (selectedFilters.rgbLighting.size > 0) {
        params.set("rgb", [...selectedFilters.rgbLighting].join(","));
      }
      if (selectedFilters.wireless) {
        params.set("wireless", "true");
      }
      if (selectedFilters.wired) {
        params.set("wired", "true");
      }

      if (currentPage > 1) {
        params.set("page", currentPage.toString());
      }

      if (currentView !== "grid") {
        params.set("view", currentView);
      }

      const newURL = params.toString()
        ? `?${params.toString()}`
        : window.location.pathname;
      window.history.replaceState({}, "", newURL);
    }

    function loadFiltersFromURL() {
      const params = new URLSearchParams(window.location.search);

      if (params.has("price")) {
        params
          .get("price")
          .split(",")
          .forEach((v) => {
            const checkbox = document.querySelector(
              `.price-filter[value="${v}"]`,
            );
            if (checkbox) {
              checkbox.checked = true;
              selectedFilters.priceCategories.add(v);
            }
          });
      }

      if (params.has("brand")) {
        params
          .get("brand")
          .split(",")
          .forEach((v) => {
            const checkbox = document.querySelector(
              `.brand-filter[value="${v}"]`,
            );
            if (checkbox) {
              checkbox.checked = true;
              selectedFilters.brands.add(v);
            }
          });
      }

      if (params.has("platform")) {
        params
          .get("platform")
          .split(",")
          .forEach((v) => {
            const checkbox = document.querySelector(
              `.platform-filter[value="${v}"]`,
            );
            if (checkbox) {
              checkbox.checked = true;
              selectedFilters.platforms.add(v);
            }
          });
      }

      if (params.has("mic")) {
        params
          .get("mic")
          .split(",")
          .forEach((v) => {
            const checkbox = document.querySelector(
              `.mic-filter[value="${v}"]`,
            );
            if (checkbox) {
              checkbox.checked = true;
              selectedFilters.microphoneTypes.add(v);
            }
          });
      }

      if (params.has("surround")) {
        params
          .get("surround")
          .split(",")
          .forEach((v) => {
            const checkbox = document.querySelector(
              `.surround-filter[value="${v}"]`,
            );
            if (checkbox) {
              checkbox.checked = true;
              selectedFilters.surroundSounds.add(v);
            }
          });
      }

      if (params.has("nc")) {
        const radio = document.querySelector(
          `.nc-filter[value="${params.get("nc")}"]`,
        );
        if (radio) {
          radio.checked = true;
          selectedFilters.noiseCancellation = params.get("nc");
        }
      }

      if (params.has("rgb")) {
        params
          .get("rgb")
          .split(",")
          .forEach((v) => {
            const checkbox = document.querySelector(
              `.rgb-filter[value="${v}"]`,
            );
            if (checkbox) {
              checkbox.checked = true;
              selectedFilters.rgbLighting.add(v);
            }
          });
      }

      if (params.get("wireless") === "true") {
        document.getElementById("filter-wireless").checked = true;
        selectedFilters.wireless = true;
      }

      if (params.get("wired") === "true") {
        document.getElementById("filter-wired").checked = true;
        selectedFilters.wired = true;
      }

      if (params.has("page")) {
        currentPage = parseInt(params.get("page")) || 1;
      }

      if (params.has("view")) {
        currentView = params.get("view");
        localStorage.setItem("headset-view", currentView);
      }
    }

    function switchView(view) {
      currentView = view;
      localStorage.setItem("headset-view", view);

      // Update button states
      document.querySelectorAll(".view-toggle-btn").forEach((btn) => {
        if (btn.dataset.view === view) {
          btn.classList.add("bg-primary", "text-white");
          btn.classList.remove("text-text/60", "hover:text-text");
        } else {
          btn.classList.remove("bg-primary", "text-white");
          btn.classList.add("text-text/60", "hover:text-text");
        }
      });

      updateURL();
      displayResults();
    }

    document.addEventListener("astro:page-load", function () {
      loadFiltersFromURL();

      // Set initial view button states
      switchView(currentView);

      applyFilters();

      document.querySelectorAll(".price-filter").forEach((cb) => {
        cb.addEventListener("change", function () {
          if (this.checked) {
            selectedFilters.priceCategories.add(this.value);
          } else {
            selectedFilters.priceCategories.delete(this.value);
          }
          applyFilters();
        });
      });

      document.querySelectorAll(".brand-filter").forEach((cb) => {
        cb.addEventListener("change", function () {
          if (this.checked) {
            selectedFilters.brands.add(this.value);
          } else {
            selectedFilters.brands.delete(this.value);
          }
          applyFilters();
        });
      });

      document.querySelectorAll(".platform-filter").forEach((cb) => {
        cb.addEventListener("change", function () {
          if (this.checked) {
            selectedFilters.platforms.add(this.value);
          } else {
            selectedFilters.platforms.delete(this.value);
          }
          applyFilters();
        });
      });

      document.querySelectorAll(".mic-filter").forEach((cb) => {
        cb.addEventListener("change", function () {
          if (this.checked) {
            selectedFilters.microphoneTypes.add(this.value);
          } else {
            selectedFilters.microphoneTypes.delete(this.value);
          }
          applyFilters();
        });
      });

      document.querySelectorAll(".surround-filter").forEach((cb) => {
        cb.addEventListener("change", function () {
          if (this.checked) {
            selectedFilters.surroundSounds.add(this.value);
          } else {
            selectedFilters.surroundSounds.delete(this.value);
          }
          applyFilters();
        });
      });

      document.querySelectorAll(".nc-filter").forEach((rb) => {
        rb.addEventListener("change", function () {
          selectedFilters.noiseCancellation = this.checked ? this.value : null;
          applyFilters();
        });
      });

      document.querySelectorAll(".rgb-filter").forEach((cb) => {
        cb.addEventListener("change", function () {
          if (this.checked) {
            selectedFilters.rgbLighting.add(this.value);
          } else {
            selectedFilters.rgbLighting.delete(this.value);
          }
          applyFilters();
        });
      });

      document
        .getElementById("filter-wireless")
        .addEventListener("change", function () {
          selectedFilters.wireless = this.checked;
          applyFilters();
        });

      document
        .getElementById("filter-wired")
        .addEventListener("change", function () {
          selectedFilters.wired = this.checked;
          applyFilters();
        });

      document
        .getElementById("platform-logic-toggle")
        .addEventListener("change", function () {
          selectedFilters.platformLogic = this.checked ? "AND" : "OR";
          applyFilters();
        });

      document
        .getElementById("clear-all-filters")
        .addEventListener("click", clearAllFilters);

      // View toggle event listeners
      document
        .getElementById("grid-view-btn")
        .addEventListener("click", () => switchView("grid"));
      document
        .getElementById("list-view-btn")
        .addEventListener("click", () => switchView("list"));

      // Show more/less event listeners
      const brandShowMoreBtn = document.getElementById("brand-show-more");
      if (brandShowMoreBtn) {
        brandShowMoreBtn.addEventListener("click", toggleBrandShowMore);
      }

      const platformShowMoreBtn = document.getElementById("platform-show-more");
      if (platformShowMoreBtn) {
        platformShowMoreBtn.addEventListener("click", togglePlatformShowMore);
      }

      // Mobile Filters Logic
      const mobileSidebar = document.getElementById("filters-sidebar");
      const mobileToggleBtn = document.getElementById("sticky-filter-toggle");
      const mobileCloseBtn = document.getElementById("close-filters-btn");
      const mobileApplyBtn = document.getElementById("mobile-apply-filters");

      function openMobileFilters() {
        if (mobileSidebar) {
          mobileSidebar.classList.remove("translate-x-full");
          mobileSidebar.classList.add("translate-x-0");
          document.body.style.overflow = "hidden";
        }
      }

      function closeMobileFilters() {
        if (mobileSidebar) {
          mobileSidebar.classList.add("translate-x-full");
          mobileSidebar.classList.remove("translate-x-0");
          document.body.style.overflow = "";
        }
      }

      if (mobileToggleBtn)
        mobileToggleBtn.addEventListener("click", openMobileFilters);
      if (mobileCloseBtn)
        mobileCloseBtn.addEventListener("click", closeMobileFilters);
      if (mobileApplyBtn)
        mobileApplyBtn.addEventListener("click", closeMobileFilters);
    });
  </script>
</div>
