---
import { ClientRouter } from "astro:transitions";
import { Headphones, Menu, Search, BookHeart, X } from "@lucide/astro";
import { getCollection } from "astro:content";
import { SEO } from "astro-seo";
import "../styles/global.css";
import MobileMenu from "../components/MobileMenu.astro";
import SearchModal from "../components/SearchModal.astro";
import CookieConsent from "../components/CookieConsent.astro";

interface Props {
	title?: string;
	description?: string;
	image?: string;
	canonicalURL?: string;
}

const {
	title = "Gaming Headset Comparison - Find Your Perfect Headset",
	description = "Compare gaming headsets by objective specs. Filter by wireless, battery life, compatibility, and more. Find the perfect gaming headset for your needs.",
	image = "https://ik.imagekit.io/gh2026/brand/goopfinder-og.png", // Fallback OG image
	canonicalURL = Astro.url.href,
} = Astro.props;

// Load data for search functionality
const headsets = await getCollection("headsets");
const blogPosts = await getCollection("blog");
const logo = "https://ik.imagekit.io/gh2026/brand/goopfinder-logo-2.svg";

// ... Preparation logic for search data remains the same ...
const headsetData = headsets.map((headset) => ({
	id: headset.slug,
	type: "headset",
	name: headset.data.name,
	brand: headset.data.brand,
	product_description: headset.data.product_description,
	platforms: headset.data.platforms,
	special_features: headset.data.special_features,
	connection_types: headset.data.connection_types,
	price: headset.data.price,
	image: headset.data.image,
	slug: headset.slug,
}));

const blogData = blogPosts.map((post) => ({
	id: post.slug,
	type: "blog",
	title: post.data.title,
	excerpt: post.data.excerpt,
	category: post.data.category,
	tags: post.data.tags,
	published: post.data.published,
	image: post.data.image,
	slug: post.slug,
}));

const searchData: any[] = [...headsetData, ...blogData];
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href="/favicon.png" />
		<meta name="generator" content={Astro.generator} />

		<SEO
			title={title}
			description={description}
			canonical={canonicalURL}
			openGraph={{
				basic: {
					title: title,
					type: "website",
					image: image,
				},
				optional: {
					description: description,
					siteName: "Goop Finder",
				},
			}}
			twitter={{
				card: "summary_large_image",
				title: title,
				description: description,
				image: image,
			}}
		/>

		<!-- Google tag (gtag.js) -->
		<script
			async
			src="https://www.googletagmanager.com/gtag/js?id=G-RXP55R0F49"
			is:inline></script>
		<script is:inline>
			window.dataLayer = window.dataLayer || [];
			function gtag() {
				dataLayer.push(arguments);
			}
			gtag("js", new Date());

			gtag("config", "G-RXP55R0F49");
		</script>
		<ClientRouter />
	</head>
	<body class="bg-background text-text">
		<nav
			class="bg-black/80 backdrop-blur-md sticky top-0 z-[60] border-b border-primary/20"
		>
			<div class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8">
				<div class="flex items-center justify-between h-16">
					<div class="flex items-center gap-2">
						<a
							href="/"
							class="text-xl font-bold text-primary hover:text-primary/80 transition-colors"
						>
							<img src={logo} alt="Goop Finder" class="h-12" />
						</a>
					</div>
					<div class="hidden lg:flex items-center space-x-6">
						<a
							href="/blog"
							class="text-text/80 hover:text-text transition-colors"
						>
							Blog
						</a>
					</div>
					<div class="flex items-center space-x-4">
						<button
							id="nav-search-button"
							class="hidden lg:block text-text/80 hover:text-text transition-colors"
							aria-label="Search"
						>
							<Search class="w-6 h-6" />
						</button>
						<a
							href="/favorites"
							class="hidden lg:block text-text/80 hover:text-text transition-colors"
							aria-label="Favorites"
						>
							<BookHeart class="w-6 h-6" />
						</a>
						<button
							id="mobile-menu-toggle"
							class="lg:hidden text-text/80 hover:text-text transition-all relative z-[70]"
							aria-label="Toggle menu"
						>
							<Menu id="menu-icon" class="w-6 h-6 block" />
							<X id="close-icon" class="w-6 h-6 hidden" />
						</button>
					</div>
				</div>
			</div>
		</nav>
		<slot />
		<footer class="border-t border-white/5 py-8 mt-20">
			<div
				class="max-w-screen-xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-text/30 text-sm tracking-wide"
			>
				<p>Â© 2026 All Rights Reserved. Goop Finder</p>
				<div class="mt-2 flex justify-center gap-4">
					<a
						href="/privacy"
						class="hover:text-text/50 transition-colors"
						>Privacy Policy</a
					>
					<a
						href="/terms"
						class="hover:text-text/50 transition-colors"
						>Terms of Service</a
					>
				</div>
			</div>
		</footer>
		<MobileMenu />
		<SearchModal searchData={searchData} />
		<CookieConsent />
		<style is:global>
			@keyframes fade-in {
				from {
					opacity: 0;
				}
				to {
					opacity: 1;
				}
			}

			@keyframes slide-up {
				from {
					opacity: 0;
					transform: translateY(20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			@keyframes slide-down {
				from {
					opacity: 0;
					transform: translateY(-20px);
				}
				to {
					opacity: 1;
					transform: translateY(0);
				}
			}

			::view-transition-old(root),
			::view-transition-new(root) {
				animation-duration: 0.4s;
			}

			@supports (view-transition-name: none) {
				img[transition^="post-image"],
				h1[transition^="post-title"],
				h2[transition^="post-title"],
				h4[transition^="post-title"] {
					view-transition-name: attr(transition);
				}
			}
		</style>
		<script>
			function setupMenu() {
				const mobileMenuToggle =
					document.getElementById("mobile-menu-toggle");
				const mobileMenu = document.getElementById("mobile-menu");
				const menuIcon = document.getElementById("menu-icon");
				const closeIcon = document.getElementById("close-icon");

				function toggleMenu() {
					const isOpen = mobileMenu?.classList.contains("open");
					if (isOpen) {
						mobileMenu?.classList.remove("open");
						document.body.style.overflow = "";
						menuIcon?.classList.remove("hidden");
						closeIcon?.classList.add("hidden");
						mobileMenuToggle?.setAttribute(
							"aria-expanded",
							"false",
						);
					} else {
						mobileMenu?.classList.add("open");
						document.body.style.overflow = "hidden";
						menuIcon?.classList.add("hidden");
						closeIcon?.classList.remove("hidden");
						mobileMenuToggle?.setAttribute("aria-expanded", "true");
					}
				}

				mobileMenuToggle?.addEventListener("click", toggleMenu);

				// Global listener to sync icon state if menu is closed from elsewhere (e.g. mobile link click)
				document.addEventListener("menu-closed", () => {
					menuIcon?.classList.remove("hidden");
					closeIcon?.classList.add("hidden");
					mobileMenuToggle?.setAttribute("aria-expanded", "false");
					document.body.style.overflow = "";
				});
			}

			// Run on initial load and subsequent navigations
			document.addEventListener("astro:page-load", setupMenu);
		</script>
		<script define:vars={{ searchData }}>
			console.log("Setting window.searchData in define:vars");
			window.searchData = { searchData };
		</script>
		<script src="/scripts/search.js" is:inline></script>
	</body>
</html>
